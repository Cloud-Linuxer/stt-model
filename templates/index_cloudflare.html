<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ¤ ì‹¤ì‹œê°„ STT - Cloudflare Tunnel</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <h1 class="title">
                <span class="title-icon">ğŸ¤</span>
                ì‹¤ì‹œê°„ ìŒì„± ì¸ì‹ (Cloudflare)
            </h1>
            <div class="status-indicator">
                <span class="status-dot" id="statusDot"></span>
                <span id="statusText">ì—°ê²° ì¤‘...</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- WebSocket URL Configuration -->
        <div class="config-panel" style="background: var(--card-bg); padding: 1.5rem; border-radius: 1rem; margin-bottom: 2rem; border: 1px solid var(--border-color);">
            <h3 style="margin-bottom: 1rem;">ğŸŒ Cloudflare Tunnel ì„¤ì •</h3>
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-bottom: 1rem;">
                <input type="text" id="wsUrl" placeholder="wss://your-tunnel.trycloudflare.com"
                       style="padding: 0.75rem; background: var(--dark-bg); color: white; border: 1px solid var(--border-color); border-radius: 0.5rem;">
                <button onclick="connectWebSocket()"
                        style="padding: 0.75rem 2rem; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 0.5rem; cursor: pointer;">
                    ì—°ê²°
                </button>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.875rem;">
                ğŸ’¡ WebSocket í„°ë„ URLì„ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: wss://your-tunnel.trycloudflare.com)
            </p>
        </div>

        <div class="main-grid">
            <!-- Control Panel -->
            <div class="control-panel">
                <h2 class="section-title">
                    <span>ğŸ›ï¸</span> ì œì–´íŒ
                </h2>

                <!-- Recording Button -->
                <button id="recordBtn" class="recording-btn start" disabled>
                    <span id="recordIcon">ğŸ™ï¸</span>
                    <span id="recordText">ë…¹ìŒ ì‹œì‘</span>
                </button>

                <!-- Audio Visualizer -->
                <div class="audio-visualizer" id="visualizer">
                    <div class="audio-bar" style="height: 20px;"></div>
                    <div class="audio-bar" style="height: 35px;"></div>
                    <div class="audio-bar" style="height: 25px;"></div>
                    <div class="audio-bar" style="height: 40px;"></div>
                    <div class="audio-bar" style="height: 30px;"></div>
                    <div class="audio-bar" style="height: 45px;"></div>
                    <div class="audio-bar" style="height: 35px;"></div>
                    <div class="audio-bar" style="height: 25px;"></div>
                    <div class="audio-bar" style="height: 30px;"></div>
                    <div class="audio-bar" style="height: 20px;"></div>
                </div>

                <!-- Language Selection -->
                <div class="control-group">
                    <label for="language">ì¸ì‹ ì–¸ì–´</label>
                    <select id="language">
                        <option value="auto">ğŸŒ ìë™ ê°ì§€</option>
                        <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´</option>
                        <option value="en">ğŸ‡ºğŸ‡¸ ì˜ì–´</option>
                        <option value="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´</option>
                        <option value="zh">ğŸ‡¨ğŸ‡³ ì¤‘êµ­ì–´</option>
                    </select>
                </div>

                <!-- Statistics -->
                <h3 class="section-title" style="margin-top: 2rem;">
                    <span>ğŸ“Š</span> í†µê³„
                </h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">ë‹¨ì–´ ìˆ˜</div>
                        <div class="stat-value" id="wordCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì„¸ì…˜ ì‹œê°„</div>
                        <div class="stat-value" id="sessionTime">0:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ì‹ ë¢°ë„</div>
                        <div class="stat-value" id="avgConfidence">-%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ê°ì§€ ì–¸ì–´</div>
                        <div class="stat-value" id="detectedLang">-</div>
                    </div>
                </div>
            </div>

            <!-- Transcription Area -->
            <div class="transcription-area">
                <div class="transcription-header">
                    <h2 class="section-title">
                        <span>ğŸ“</span> ì¸ì‹ ê²°ê³¼
                    </h2>
                    <button class="export-btn" onclick="exportTranscription()">
                        <span>ğŸ’¾</span> ë‚´ë³´ë‚´ê¸°
                    </button>
                </div>
                <div class="transcription-content" id="transcriptionContent">
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ¤</div>
                        <p>ë…¹ìŒ ë²„íŠ¼ì„ ëˆŒëŸ¬ ìŒì„± ì¸ì‹ì„ ì‹œì‘í•˜ì„¸ìš”</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Features -->
        <div class="features-grid">
            <div class="feature-card">
                <div class="feature-icon">ğŸš€</div>
                <h3 class="feature-title">ì‹¤ì‹œê°„ ì²˜ë¦¬</h3>
                <p class="feature-description">WebSocket ìŠ¤íŠ¸ë¦¬ë°ìœ¼ë¡œ ë‚®ì€ ì§€ì—°ì‹œê°„ ì‹¤í˜„</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸŒ</div>
                <h3 class="feature-title">ë‹¤êµ­ì–´ ì§€ì›</h3>
                <p class="feature-description">í•œêµ­ì–´, ì˜ì–´, ì¼ë³¸ì–´, ì¤‘êµ­ì–´ ìë™ ê°ì§€</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">âš¡</div>
                <h3 class="feature-title">GPU ê°€ì†</h3>
                <p class="feature-description">Faster-Whisperë¡œ ë¹ ë¥¸ ì²˜ë¦¬ ì†ë„</p>
            </div>
            <div class="feature-card">
                <div class="feature-icon">ğŸ”’</div>
                <h3 class="feature-title">ë³´ì•ˆ ì—°ê²°</h3>
                <p class="feature-description">Cloudflare Tunnelì„ í†µí•œ ì•ˆì „í•œ HTTPS/WSS</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-content">
            <p>Powered by Whisper Large v3 & Faster-Whisper</p>
            <div class="tech-stack">
                <span class="tech-badge">Cloudflare Tunnel</span>
                <span class="tech-badge">WebSocket</span>
                <span class="tech-badge">Flask</span>
                <span class="tech-badge">CTranslate2</span>
            </div>
        </div>
    </footer>

    <script>
        let ws = null;
        let mediaRecorder = null;
        let audioContext = null;
        let analyser = null;
        let microphone = null;
        let isRecording = false;
        let sessionStartTime = null;
        let wordCount = 0;
        let totalConfidence = 0;
        let confidenceCount = 0;
        let transcriptionHistory = [];

        // WebSocket ì—°ê²°
        function connectWebSocket() {
            const wsUrlInput = document.getElementById('wsUrl');
            const wsUrl = wsUrlInput.value.trim();

            if (!wsUrl) {
                showToast('WebSocket URLì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            // ê¸°ì¡´ ì—°ê²° ì¢…ë£Œ
            if (ws) {
                ws.close();
            }

            // URL í¬ë§· í™•ì¸ ë° ìˆ˜ì •
            let finalUrl = wsUrl;
            if (!wsUrl.startsWith('ws://') && !wsUrl.startsWith('wss://')) {
                // Cloudflare Tunnelì€ HTTPSì´ë¯€ë¡œ WSS ì‚¬ìš©
                finalUrl = 'wss://' + wsUrl;
            }

            console.log('Connecting to:', finalUrl);
            updateStatus('ì—°ê²° ì¤‘...', false);

            try {
                ws = new WebSocket(finalUrl);

                ws.onopen = () => {
                    console.log('WebSocket connected');
                    updateStatus('ì—°ê²°ë¨', true);
                    document.getElementById('recordBtn').disabled = false;

                    // ì–¸ì–´ ì„¤ì • ì „ì†¡
                    const language = document.getElementById('language').value;
                    ws.send(JSON.stringify({
                        type: 'config',
                        language: language
                    }));

                    showToast('WebSocket ì—°ê²° ì„±ê³µ!', 'success');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);

                    if (data.type === 'transcription') {
                        addTranscription(data);
                        updateStats(data);
                    } else if (data.type === 'config_updated') {
                        console.log('Config updated:', data);
                    }
                };

                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    updateStatus('ì—°ê²° ì˜¤ë¥˜', false);
                    showToast('WebSocket ì—°ê²° ì˜¤ë¥˜', 'error');
                };

                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    updateStatus('ì—°ê²° ëŠê¹€', false);
                    document.getElementById('recordBtn').disabled = true;
                    if (isRecording) {
                        stopRecording();
                    }
                };
            } catch (error) {
                console.error('WebSocket connection error:', error);
                showToast('ì—°ê²° ì‹¤íŒ¨: ' + error.message, 'error');
            }
        }

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(text, connected) {
            document.getElementById('statusText').textContent = text;
            const dot = document.getElementById('statusDot');
            if (connected) {
                dot.classList.remove('disconnected');
            } else {
                dot.classList.add('disconnected');
            }
        }

        // ë…¹ìŒ ì‹œì‘/ì¤‘ì§€
        document.getElementById('recordBtn').addEventListener('click', async () => {
            if (!isRecording) {
                await startRecording();
            } else {
                stopRecording();
            }
        });

        // ë…¹ìŒ ì‹œì‘
        async function startRecording() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        channelCount: 1,
                        sampleRate: 16000,
                        sampleSize: 16,
                        echoCancellation: true,
                        noiseSuppression: true
                    }
                });

                // Audio Context ì„¤ì •
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);

                const scriptProcessor = audioContext.createScriptProcessor(4096, 1, 1);

                microphone.connect(analyser);
                analyser.connect(scriptProcessor);
                scriptProcessor.connect(audioContext.destination);

                // ì˜¤ë””ì˜¤ ì‹œê°í™”
                visualizeAudio();

                // ì˜¤ë””ì˜¤ ë°ì´í„° ì²˜ë¦¬
                scriptProcessor.onaudioprocess = (event) => {
                    if (!isRecording) return;

                    const audioData = event.inputBuffer.getChannelData(0);

                    // Float32Arrayë¥¼ Base64ë¡œ ì¸ì½”ë”©
                    const bytes = new Float32Array(audioData);
                    const base64 = btoa(String.fromCharCode.apply(null, new Uint8Array(bytes.buffer)));

                    // WebSocketìœ¼ë¡œ ì „ì†¡
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({
                            type: 'audio',
                            data: base64,
                            sampleRate: audioContext.sampleRate
                        }));
                    }
                };

                isRecording = true;
                sessionStartTime = Date.now();
                updateRecordButton(true);
                updateSessionTime();

                // ì„¸ì…˜ ì‹œê°„ ì—…ë°ì´íŠ¸
                setInterval(updateSessionTime, 1000);

            } catch (error) {
                console.error('Error accessing microphone:', error);
                alert('ë§ˆì´í¬ ì ‘ê·¼ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
            }
        }

        // ë…¹ìŒ ì¤‘ì§€
        function stopRecording() {
            isRecording = false;

            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }

            updateRecordButton(false);
        }

        // ë²„íŠ¼ ì—…ë°ì´íŠ¸
        function updateRecordButton(recording) {
            const btn = document.getElementById('recordBtn');
            const icon = document.getElementById('recordIcon');
            const text = document.getElementById('recordText');

            if (recording) {
                btn.classList.remove('start');
                btn.classList.add('stop');
                icon.textContent = 'â¹ï¸';
                text.textContent = 'ë…¹ìŒ ì¤‘ì§€';
            } else {
                btn.classList.remove('stop');
                btn.classList.add('start');
                icon.textContent = 'ğŸ™ï¸';
                text.textContent = 'ë…¹ìŒ ì‹œì‘';
            }
        }

        // ì˜¤ë””ì˜¤ ì‹œê°í™”
        function visualizeAudio() {
            if (!analyser) return;

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);

            function draw() {
                if (!isRecording) return;

                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);

                const bars = document.querySelectorAll('.audio-bar');
                bars.forEach((bar, index) => {
                    const value = dataArray[index * 10] || 0;
                    const height = Math.max(10, (value / 255) * 60);
                    bar.style.height = `${height}px`;
                });
            }

            draw();
        }

        // ì „ì‚¬ ê²°ê³¼ ì¶”ê°€
        function addTranscription(data) {
            const content = document.getElementById('transcriptionContent');

            // ë¹ˆ ìƒíƒœ ì œê±°
            const emptyState = content.querySelector('.empty-state');
            if (emptyState) {
                emptyState.remove();
            }

            // ìƒˆ ì„¸ê·¸ë¨¼íŠ¸ ì¶”ê°€
            const segment = document.createElement('div');
            segment.className = 'transcription-segment';

            const time = new Date(data.timestamp * 1000);
            const timeStr = time.toLocaleTimeString('ko-KR');

            segment.innerHTML = `
                <div class="segment-meta">
                    <span class="timestamp">${timeStr}</span>
                    <span class="language-badge">${data.language.toUpperCase()}</span>
                    <span class="confidence">${(data.confidence * 100).toFixed(1)}%</span>
                </div>
                <div class="segment-text">${data.text}</div>
            `;

            content.appendChild(segment);
            content.scrollTop = content.scrollHeight;

            // íˆìŠ¤í† ë¦¬ì— ì¶”ê°€
            transcriptionHistory.push({
                time: timeStr,
                language: data.language,
                confidence: data.confidence,
                text: data.text
            });
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(data) {
            // ë‹¨ì–´ ìˆ˜
            const words = data.text.split(/\s+/).filter(w => w.length > 0);
            wordCount += words.length;
            document.getElementById('wordCount').textContent = wordCount;

            // í‰ê·  ì‹ ë¢°ë„
            totalConfidence += data.confidence;
            confidenceCount++;
            const avgConfidence = (totalConfidence / confidenceCount * 100).toFixed(1);
            document.getElementById('avgConfidence').textContent = `${avgConfidence}%`;

            // ê°ì§€ ì–¸ì–´
            document.getElementById('detectedLang').textContent = data.language.toUpperCase();
        }

        // ì„¸ì…˜ ì‹œê°„ ì—…ë°ì´íŠ¸
        function updateSessionTime() {
            if (!sessionStartTime) return;

            const elapsed = Math.floor((Date.now() - sessionStartTime) / 1000);
            const minutes = Math.floor(elapsed / 60);
            const seconds = elapsed % 60;

            document.getElementById('sessionTime').textContent =
                `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }

        // ì–¸ì–´ ë³€ê²½
        document.getElementById('language').addEventListener('change', (e) => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'config',
                    language: e.target.value
                }));
            }
        });

        // ë‚´ë³´ë‚´ê¸°
        function exportTranscription() {
            if (transcriptionHistory.length === 0) {
                alert('ë‚´ë³´ë‚¼ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            let text = '=== ìŒì„± ì¸ì‹ ê²°ê³¼ ===\n\n';
            transcriptionHistory.forEach(item => {
                text += `[${item.time}] (${item.language.toUpperCase()}, ${(item.confidence * 100).toFixed(1)}%)\n`;
                text += `${item.text}\n\n`;
            });

            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `transcription_${new Date().toISOString().slice(0, 10)}.txt`;
            a.click();
        }

        // Toast ì•Œë¦¼
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            setTimeout(() => {
                toast.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì—°ê²° ì‹œë„ (ë¡œì»¬ í…ŒìŠ¤íŠ¸ìš©)
        window.addEventListener('load', () => {
            // ë¡œì»¬ í™˜ê²½ì—ì„œëŠ” ìë™ ì—°ê²°
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                document.getElementById('wsUrl').value = 'ws://localhost:8766';
                // connectWebSocket(); // ìë™ ì—°ê²° ì›í•˜ë©´ ì£¼ì„ í•´ì œ
            }
        });
    </script>
</body>
</html>